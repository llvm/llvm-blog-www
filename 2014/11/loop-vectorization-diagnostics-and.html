<!doctype html><html lang=en><head><title>Loop Vectorization: Diagnostics and Control - The LLVM Project Blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="LLVM Project News and Details from the Trenches"><meta name=author content="Tyler Nowicki"><meta property="og:url" content="https://blog.llvm.org/2014/11/loop-vectorization-diagnostics-and.html"><meta property="og:site_name" content="The LLVM Project Blog"><meta property="og:title" content="Loop Vectorization: Diagnostics and Control"><meta property="og:description" content="Loop vectorization was first introduced in LLVM 3.2 and turned on by default in LLVM 3.3. It has been discussed previously on this blog in 2012 and 2013, as well as at FOSDEM 2014, and at Apple's WWDC 2013."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-11-24T15:12:00+00:00"><meta property="article:modified_time" content="2014-11-24T15:12:00+00:00"><meta property="article:tag" content="C++"><meta property="article:tag" content="Optimization"><meta property="article:tag" content="Loops"><meta property="article:tag" content="Vectorization"><meta name=twitter:card content="summary"><meta name=twitter:title content="Loop Vectorization: Diagnostics and Control"><meta name=twitter:description content="Loop vectorization was first introduced in LLVM 3.2 and turned on by default in LLVM 3.3. It has been discussed previously on this blog in 2012 and 2013, as well as at FOSDEM 2014, and at Apple's WWDC 2013."><meta name=generator content="Hugo 0.128.0"><link rel=stylesheet href=https://blog.llvm.org/css/normalize.min.css><link rel=stylesheet href=https://blog.llvm.org/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://blog.llvm.org/css/styles.css></head><body><div id=container><header><h1><a href=https://blog.llvm.org/>The LLVM Project Blog</a></h1><ul id=social-media><li><a href=https://www.facebook.com/llvmorg title=Facebook><i class="fab fa-facebook fa-lg"></i></a></li><li><a href=https://github.com/llvm title=GitHub><i class="fab fa-github fa-lg"></i></a></li><li><a href=https://twitter.com/llvmorg title=Twitter><i class="fab fa-twitter fa-lg"></i></a></li><li><a href=https://www.youtube.com/c/LLVMPROJ title=Youtube><i class="fab fa-youtube fa-lg"></i></a></li></ul><p><em>LLVM Project News and Details from the Trenches</em></p></header><nav><ul><li><a href=https://blog.llvm.org/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://blog.llvm.org/posts><i class="fa-li fa fa-lg"></i><span>Posts</span></a></li><li><a href=https://blog.llvm.org/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li><li><a href=https://llvm.org/><i class="fa-li fa fa-lg"></i><span>llvm.org</span></a></li></ul></nav><main><article><h1>Loop Vectorization: Diagnostics and Control</h1><aside><ul><li><time class=post-date datetime=2014-11-24T15:12:00Z>Nov 24, 2014</time></li><li><em><a href=https://blog.llvm.org/tags/c++>#C++</a>
,
<a href=https://blog.llvm.org/tags/optimization>#optimization</a>
,
<a href=https://blog.llvm.org/tags/loops>#loops</a>
,
<a href=https://blog.llvm.org/tags/vectorization>#vectorization</a></em></li><li>5 minute read</li></ul></aside><span style=font-weight:400><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><a href=http://llvm.org/docs/Vectorizers.html style=letter-spacing:0;text-align:justify><span style=letter-spacing:0>Loop vectorization</span></a><span style=letter-spacing:0;text-align:justify> was first introduced in LLVM 3.2 and turned on by default in LLVM 3.3. It has been discussed previously on this blog in </span><a href=http://blog.llvm.org/2012/12/new-loop-vectorizer.html style=letter-spacing:0;text-align:justify><span style=letter-spacing:0>2012</span></a><span style=letter-spacing:0;text-align:justify> and </span><a href=http://blog.llvm.org/2013/05/llvm-33-vectorization-improvements.html style=letter-spacing:0;text-align:justify><span style=letter-spacing:0>2013</span></a><span style=letter-spacing:0;text-align:justify>, as well as at </span><a href=https://archive.fosdem.org/2014/schedule/event/llvmautovec/ style=letter-spacing:0;text-align:justify><span style=letter-spacing:0>FOSDEM 2014</span></a><span style=letter-spacing:0;text-align:justify>, and at&nbsp;</span><a href=http://llvm.org/devmtg/2013-11/#talk10 style=letter-spacing:0;text-align:justify><span style=letter-spacing:0>Apple's WWDC 2013</span></a><span style=letter-spacing:0;text-align:justify>. The LLVM loop vectorizer combines multiple iterations of a loop to improve performance. Modern processors can exploit the independence of the interleaved instructions using advanced hardware features, such as multiple execution units and out-of-order execution, to improve performance.</span></span></span><br><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0">Unfortunately, when loop vectorization is not possible or profitable the loop is silently skipped. This is a problem for many applications that rely on the performance vectorization provides. Recent updates to LLVM provide command line arguments to help diagnose vectorization issues and new a pragma syntax for tuning loop vectorization, interleaving, and unrolling.</span></div><h2><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;font-size:large;letter-spacing:0"><b>New Feature: Diagnostics Remarks</b></span></h2><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0;text-decoration:underline><a href=http://llvm.org/docs/Vectorizers.html#diagnostics>Diagnostic remarks</a></span><span style=letter-spacing:0> provide the user with an insight into the behavior of the behavior of LLVM’s optimization passes including unrolling, interleaving, and vectorization. They are enabled using the <a href=http://clang.llvm.org/docs/UsersManual.html#options-to-emit-optimization-reports><span style=letter-spacing:0>Rpass command line arguments</span></a>. Interleaving and vectorization diagnostic remarks are produced by specifying the ‘loop-vectorize’ pass. For example, specifying ‘-Rpass=loop-vectorize’ tells us the following loop was vectorized by 4 and interleaved by 2.</span><span style=letter-spacing:0><span style=letter-spacing:0></span></span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">void test1(int *List, int Length) {</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; int i = 0;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; while(i &lt; Length) {</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; List[i] = i*2;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; i++;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; }</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">}</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>clang -O3 </span><span style=color:#ae1916;letter-spacing:0px>-Rpass=loop-vectorize </span><span style=letter-spacing:0px>-S test1.c -o /dev/null</span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>test1.c:4:5: </span><span style=color:#5330e1;letter-spacing:0px>remark:&nbsp;</span></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=color:#5330e1;letter-spacing:0px><span class=Apple-tab-span style=white-space:pre></span></span><span style=letter-spacing:0px>vectorized loop (vectorization factor: 4, unrolling interleave factor: 2)</span></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; <span class=Apple-tab-span style=white-space:pre></span></span><span style="font-family:Courier New,Courier,monospace">while(i &lt; Length) {</span></div><div style=color:#34bd26><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0>&nbsp; &nbsp; <span class=Apple-tab-span style=white-space:pre></span></span><span style=color:#01a900;letter-spacing:0>^</span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0px">Many loops cannot be vectorized including loops with complicated control flow, unvectorizable types, and unvectorizable calls. For example, to prove it is safe to vectorize the following loop we must prove that array ‘A’ is not an alias of array ‘B’. However, the bounds of array ‘A’ cannot be identified.</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">void test2(int *A, int *B, int Length) {</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; for (int i = 0; i &lt; Length; i++)</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; A[B[i]]++;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">}</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0>clang -O3 </span><span style=color:#ae1916;letter-spacing:0>-Rpass-analysis=loop-vectorize </span><span style=letter-spacing:0>-S test2.c -o /dev/null</span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>test2.c:3:5: </span><span style=color:#5330e1;letter-spacing:0px>remark:<br></span></span></div><span style="font-family:Courier New,Courier,monospace"><span style=color:#5330e1;letter-spacing:0px><span class=Apple-tab-span style=white-space:pre></span></span><span style=letter-spacing:0px>loop not vectorized: cannot identify array bounds</span></span><br><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px"><span class=Apple-tab-span style=white-space:pre></span>&nbsp; &nbsp;&nbsp;</span><span style="font-family:Courier New,Courier,monospace">for (int i = 0; i &lt; Length; i++)</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px><span class=Apple-tab-span style=white-space:pre></span>&nbsp; &nbsp; </span><span style=color:#01a900;letter-spacing:0px>^</span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0">Control flow and other unvectorizable statements are reported by the '-Rpass-analysis' command line argument. For example, many uses of ‘break’ and ‘switch’ are not vectorizable.</span><br><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0"><br></span></div><table align=center style=border-collapse:collapse;width:90%><thead><tr style=background-color:silver><th width=300px><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace;font-size:small">C/C++ Code</span></span></th><th><span style="font-family:Courier New,Courier,monospace">-Rpass-analysis=loop-vectorize</span></th></tr></thead><tbody><tr style=background-color:#e8e8e8><td><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">for (int i = 0; i &lt; Length; i++) {</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; if (A[i] > 10.0)</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; &nbsp; break;</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; A[i] = 0;</span></span></div><div><span style="font-family:Courier New,Courier,monospace"><br></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">}</span></span></div></td><td><div style=text-align:justify><div style=text-align:left><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0>control_flow.cpp:5:9:&nbsp;</span><span style=color:#5330e1;letter-spacing:0>remark:&nbsp;</span><span style=letter-spacing:0>loop not vectorized: loop control flow is not understood by vectorizer</span></span></div></div><div style=text-align:justify><div style=text-align:left><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; &nbsp; if (A[i] > 10.0)</span></span></div></div><div><span style="font-family:Courier New,Courier,monospace"><br></span></div><div style=text-align:justify><div style=text-align:left><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><span style=color:#578726;letter-spacing:0>^</span></span></div></div></td></tr><tr style=background-color:#d7d7d7><td><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">for (int i = 0; i &lt; Length; i++) {</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; switch(A[i]) {</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; case 0: B[i] = 1; break;</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; case 1: B[i] = 2; break;</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; default: B[i] = 3;</span></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; }</span></span></div><div><span style="font-family:Courier New,Courier,monospace"><br></span></div><div><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">}</span></span></div></td><td><div style=text-align:justify><div style=text-align:left><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0>no_switch.cpp:4:5:&nbsp;</span><span style=color:#5330e1;letter-spacing:0>remark:&nbsp;</span><span style=letter-spacing:0>loop not vectorized: loop contains a switch statement</span></span></div></div><div style=text-align:justify><div style=text-align:left><span style=letter-spacing:0><span style="font-family:Courier New,Courier,monospace">&nbsp; &nbsp; switch(A[i]) {</span></span></div></div><div><span style="font-family:Courier New,Courier,monospace"><br></span></div><div style=text-align:justify><div style=text-align:left><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0>&nbsp; &nbsp;&nbsp;</span><span style=color:#578726;letter-spacing:0>^</span></span></div></div></td></tr></tbody></table><br><h2><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;font-size:large;letter-spacing:0"><b>New Feature: Loop Pragma Directive</b></span></h2><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0>Explicitly control over the behavior of vectorization, interleaving and unrolling is necessary to fine tune the performance. For example, when compiling for size (-Os) it's a good idea to vectorize the hot loops of the application to improve performance. Vectorization, interleaving, and unrolling can be explicitly specified using the </span><a href=http://clang.llvm.org/docs/LanguageExtensions.html#extensions-for-loop-hint-optimizations style=letter-spacing:0><span style=letter-spacing:0>#pragma clang loop</span></a><span style=letter-spacing:0>&nbsp;</span>directive<span style=letter-spacing:0>&nbsp;prior to any for, while, do-while, or c++11 range-based for loop. For example, the vectorization width and interleaving count is explicitly specified for the following loop using the loop pragma directive.</span><span style=letter-spacing:0><span style=letter-spacing:0></span></span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">void test3(float *Vx, float *Vy, float *Ux, float *Uy, float *P, int Length) {</span></div><div style=color:#ae1916><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">#pragma clang loop vectorize_width(4) interleave_count(4)</span></div><div style=color:#ae1916><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">#pragma clang loop unroll(disable)</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; for (int i = 0; i &lt; Length; i++) {</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; float A = Vx[i] * Ux[i];</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; float B = A + Vy[i] * Uy[i];</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; P[i] = B;</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp;&nbsp; }</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">}</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>clang -O3 </span><span style=color:#ae1916;letter-spacing:0px>-Rpass=loop-vectorize </span><span style=letter-spacing:0px>-S test3.c -o /dev/null</span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>test3.c:5:5: </span><span style=color:#5330e1;letter-spacing:0px>remark:</span></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=color:#5330e1;letter-spacing:0px><span class=Apple-tab-span style=white-space:pre></span></span><span style=letter-spacing:0px>vectorized loop (vectorization factor: 4, unrolling interleave factor: 4)</span></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px"><span class=Apple-tab-span style=white-space:pre></span>&nbsp; &nbsp;&nbsp;</span><span style="font-family:Courier New,Courier,monospace">for (int i = 0; i &lt; Length; i++) {</span></div><div style=color:#34bd26><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0><span class=Apple-tab-span style=white-space:pre></span>&nbsp; &nbsp; </span><span style=color:#01a900;letter-spacing:0>^</span></span></div><h3><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;font-size:large;letter-spacing:0"><b>Integer Constant Expressions</b></span></h3><div style=text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0">The options vectorize_width, interleave_count, and unroll_count take an integer constant expression. So it can be computed as in the example below.</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">template &lt;int ArchWidth, int ExecutionUnits></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">void test4(float *Vx, float *Vy, float *Ux, float *Uy, float *P, int Length) {</span></div><div style=color:#ae1916><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">#pragma clang loop vectorize_width(ArchWidth)</span></div><div style=color:#ae1916><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">#pragma clang loop interleave_count(ExecutionUnits * 4)</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; for (int i = 0; i &lt; Length; i++) {</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; float A = Vx[i] * Ux[i];</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; float B = A + Vy[i] * Uy[i];</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; P[i] = B;</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp;&nbsp; }</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">}</span></div><div style=min-height:13px><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">void compute_test4(float *Vx, float *Vy, float *Ux, float *Uy, float *P, int Length) {</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; const int arch_width = 4;</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; const int exec_units = 2;</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; test4&lt;arch_width, exec_units>(Vx, Vy, Ux, Uy, P, Length);</span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">}</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>clang -O3 </span><span style=color:#ae1916;letter-spacing:0px>-Rpass=loop-vectorize </span><span style=letter-spacing:0px>-S test4.cpp -o /dev/null</span></span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>test4.cpp:6:5: </span><span style=color:#5330e1;letter-spacing:0px>remark:</span></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=color:#5330e1;letter-spacing:0px><span class=Apple-tab-span style=white-space:pre></span></span><span style=letter-spacing:0px>vectorized loop (vectorization factor: 4, unrolling interleave factor: 8)</span></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px"><span class=Apple-tab-span style=white-space:pre></span>&nbsp; &nbsp;&nbsp;</span><span style="font-family:Courier New,Courier,monospace">for (int i = 0; i &lt; Length; i++) {</span></div><div style=color:#34bd26><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0><span class=Apple-tab-span style=white-space:pre></span>&nbsp; &nbsp; </span><span style=color:#01a900;letter-spacing:0>^</span></span></div><h3><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;font-size:large;letter-spacing:0px"><b>Performance Warnings</b></span></h3><div style=text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0">Sometimes the loop transformation is not safe to perform. For example, vectorization fails due to the use of complex control flow. If vectorization is explicitly specified a warning message is produced to alert the programmer that the directive cannot be followed. For example, the following function which returns the last positive value in the loop, cannot be vectorized because the ‘last_positive_value’ variable is used outside the loop.</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">int test5(int *List, int Length) {</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; int last_positive_index = 0;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; #pragma clang loop vectorize(enable)</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; for (int i = 1; i &lt; Length; i++) {</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; if (List[i] > 0) {</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; &nbsp; last_positive_index = i;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; &nbsp; continue;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; }</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; List[i] = 0;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; }</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; return last_positive_index;</span></div><div style=text-align:justify><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">}</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">clang -O3 -g -S test5.c -o /dev/null</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px></span><br></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=letter-spacing:0px>test5.c:5:9: </span><span style=color:#d53bd3;letter-spacing:0px>warning:</span></span></div><div><span style="font-family:Courier New,Courier,monospace"><span style=color:#d53bd3;letter-spacing:0px><span class=Apple-tab-span style=white-space:pre></span></span><span style=letter-spacing:0px>loop not vectorized: failed explicitly specified loop vectorization</span></span></div><div><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp;&nbsp;</span><span style="font-family:Courier New,Courier,monospace">for (int i = 1; i &lt; Length; i++) {</span></div><div style=color:#34bd26><span style="font-family:Courier New,Courier,monospace;letter-spacing:0px">&nbsp; &nbsp; &nbsp; &nbsp; ^</span></div><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif"><span style=letter-spacing:0px></span><br></span></div><div style=text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0">The debug option ‘-g’ allows the source line to be provided with the warning.</span></div><h3><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;font-size:large;letter-spacing:0px"><b>Conclusion</b></span></h3><div style=min-height:13px;text-align:justify><span style="font-family:Helvetica Neue,Arial,Helvetica,sans-serif;letter-spacing:0">Diagnostic remarks and the loop pragma directive are two new features that are useful for feedback-directed-performance tuning. Special thanks to all of the people who contributed to the development of these features. Future work includes adding diagnostic remarks to the SLP vectorizer and an additional option for the loop pragma directive to declare the memory operations as safe to vectorize. Additional ideas for improvements are welcome.</span></div></article><section class=post-nav><ul><li><a href=https://blog.llvm.org/2014/11/llvm-weekly-47-nov-24th-2014.html><i class="fa fa-chevron-circle-left"></i> LLVM Weekly - #47, Nov 24th 2014</a></li><li><a href=https://blog.llvm.org/2014/12/llvm-weekly-48-dec-1st-2014.html>LLVM Weekly - #48, Dec 1st 2014 <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><ul><li><h6>llvm.org |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://blog.llvm.org/index.xml>Subscribe</a></h6></li></ul></footer></div><script src=https://blog.llvm.org/js/scripts.js></script></body></html>
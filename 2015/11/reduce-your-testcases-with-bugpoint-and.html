<!doctype html><html lang=en><head><title>Reduce Your Testcases with Bugpoint and Custom Scripts - The LLVM Project Blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="LLVM Project News and Details from the Trenches"><meta name=author content="Joker-eph"><meta property="og:url" content="https://blog.llvm.org/2015/11/reduce-your-testcases-with-bugpoint-and.html"><meta property="og:site_name" content="The LLVM Project Blog"><meta property="og:title" content="Reduce Your Testcases with Bugpoint and Custom Scripts"><meta property="og:description" content="LLVM provides many useful command line tools to handle bitcode: opt is the most widely known and is used to run individual passes on an IR module, and llc invokes the backend to generate an assembly or object file from an IR module."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-11-12T20:18:00+00:00"><meta property="article:modified_time" content="2015-11-12T20:18:00+00:00"><meta property="article:tag" content="Bugpoint"><meta name=twitter:card content="summary"><meta name=twitter:title content="Reduce Your Testcases with Bugpoint and Custom Scripts"><meta name=twitter:description content="LLVM provides many useful command line tools to handle bitcode: opt is the most widely known and is used to run individual passes on an IR module, and llc invokes the backend to generate an assembly or object file from an IR module."><meta name=generator content="Hugo 0.128.0"><link rel=stylesheet href=https://blog.llvm.org/css/normalize.min.css><link rel=stylesheet href=https://blog.llvm.org/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://blog.llvm.org/css/styles.css></head><body><div id=container><header><h1><a href=https://blog.llvm.org/>The LLVM Project Blog</a></h1><ul id=social-media><li><a href=https://www.facebook.com/llvmorg title=Facebook><i class="fab fa-facebook fa-lg"></i></a></li><li><a href=https://github.com/llvm title=GitHub><i class="fab fa-github fa-lg"></i></a></li><li><a href=https://twitter.com/llvmorg title=Twitter><i class="fab fa-twitter fa-lg"></i></a></li><li><a href=https://www.youtube.com/c/LLVMPROJ title=Youtube><i class="fab fa-youtube fa-lg"></i></a></li></ul><p><em>LLVM Project News and Details from the Trenches</em></p></header><nav><ul><li><a href=https://blog.llvm.org/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://blog.llvm.org/posts><i class="fa-li fa fa-lg"></i><span>Posts</span></a></li><li><a href=https://blog.llvm.org/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li><li><a href=https://llvm.org/><i class="fa-li fa fa-lg"></i><span>llvm.org</span></a></li></ul></nav><main><article><h1>Reduce Your Testcases with Bugpoint and Custom Scripts</h1><aside><ul><li>By Joker-eph</li><li><time class=post-date datetime=2015-11-12T20:18:00Z>Nov 12, 2015</time></li><li><em><a href=https://blog.llvm.org/tags/bugpoint>#bugpoint</a></em></li><li>8 minute read</li></ul></aside><div dir=ltr style=text-align:left trbidi=on><div style=text-align:left><div style=text-align:left>LLVM provides many useful command line tools to handle bitcode:&nbsp;<i>opt</i>&nbsp;is the most widely known and is used to run individual passes on an IR module, and&nbsp;<i>llc</i>&nbsp;invokes the backend to generate an assembly or object file from an IR module. Less known but very powerful is&nbsp;<i>bugpoint</i>, the automatic test case reduction tool, that should be part of every developer's toolbox.</div><div style=text-align:left><br></div><div style=text-align:left>The&nbsp;<i>bugpoint</i>&nbsp;tool helps to reduce an input IR file while preserving some interesting behavior, usually a compiler crash or a miscompile. Multiple strategies are involved in the reduction of the test case (shuffling instructions, modifying the control flow, etc.), but because it is oblivious to the LLVM passes and the individual backend specificities, "it may appear to do stupid things or miss obvious simplifications", as stated in the&nbsp;<a href=http://llvm.org/docs/CommandGuide/bugpoint.html#description>official description</a>. The&nbsp;<a href=http://llvm.org/docs/Bugpoint.html>documentation</a>&nbsp;gives some insights on the strategies that can be involved by&nbsp;<i>bugpoint</i>, but the details are&nbsp;beyond the scope of this post.<br><br>Read on to learn how you can use the power of bugpoint to solve some non-obvious problems.<br><br><a name=more></a></div><h2 style=text-align:left>Bugpoint Interface Considered Harmful</h2>Bugpoint is a powerful tool to reduce your test case, but its interface can lead to frustration (as stated in the documentation: "<i>bugpoint can be a remarkably useful tool, but it sometimes works in non-obvious ways</i>"). One of the main issue seems to be that&nbsp;<i>bugpoint</i>&nbsp;is ironically too advanced! It operates under three modes and switches automatically among them to solve different kind of problem: crash, miscompilation, or code generation (see&nbsp;<a href=http://llvm.org/docs/Bugpoint.html>the documentation</a>&nbsp;for more information on these modes). However it is not always obvious to know beforehand which mode will be activated and which strategy&nbsp;<i>bugpoint</i>&nbsp;is actually using.</div><br>I found that for most of my uses, I don't want the&nbsp;<i>advanced</i>&nbsp;<i>bugpoint</i>&nbsp;features that deal with pass ordering for example, and I don't need&nbsp;<i>bugpoint</i>&nbsp;to detect which mode to operate and switch automatically. For most of my usage, the `compile-custom` option is perfectly adequate: similar to<br>`git bisect`, it allows you to provide a script to&nbsp;<i>bugpoint</i>. This script is a black box for&nbsp;<i>bugpoint</i>, it needs to accept a single argument (the bitcode file to process) and needs to return 0 if the bitcode does not exhibit the behavior you're interested in, or a non zero value in the other case.&nbsp;<i>Bugpoint</i>&nbsp;will apply multiple strategies in order to reduce the test case, and will call your custom script after each transformation to validate if the behavior you're looking for is still exhibited. The invocation for&nbsp;<i>bugpoint</i>&nbsp;is the following:<br><br><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>$ ./bin/bugpoint -compile-custom -compile-command=./check.sh -opt-command=./bin/opt my_test_case.ll</div><br>The important part is the two options&nbsp;<i>-compile-custom</i>&nbsp;and&nbsp;<i>-compile-command=path_to_script.sh</i>&nbsp;that indicate to&nbsp;<i>bugpoint</i>&nbsp;that it should use your own script to process the file. The other important part is the&nbsp;<i>-opt-command</i>&nbsp;option that should point to the correct&nbsp;<i>opt</i>&nbsp;that will be used to reduce the test case. Indeed by default&nbsp;<i>bugpoint</i>&nbsp;will search in the path for&nbsp;<i>opt</i>&nbsp;and may use an old system one that won't be able to process your IR properly, leading to some curious error message:<br><br><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>*** Debugging code generator crash!</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Checking for crash with only these blocks:&nbsp; diamond .preheader .lr.ph .end: error: Invalid type for value</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>simplifycfg failed!</div><div><br></div>Considering such a script `check.sh`, running it with your original test case this way:<br><br><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>$ ./check.sh my_test_case.ll && echo "NON-INTERESTING" || echo "INTERESTING"</div><br>should display&nbsp;<span style=background-color:#000;color:#f5f5f5;font-family:monaco;font-size:12px>INTERESTING</span>&nbsp;before you try to use it with bugpoint, or you may very well be surprised. In fact&nbsp;<i>bugpoint</i>&nbsp;considers the script as a compile command. If you start with an&nbsp;<span style=background-color:#000;color:#f5f5f5;font-family:monaco;font-size:12px>NON-INTERESTING</span>&nbsp;test case and feed it to&nbsp;<i>bugpoint</i>, it will assume that the code compiles correctly, and will try to assemble it, link it, and execute it to get a reference result. This is where&nbsp;<i>bugpoint</i>&nbsp;behavior can be confusing when it automatically switches mode, leaving the user with a confusing trace. A correct invocation should lead to a trace such as:<br><br><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>./bin/bugpoint&nbsp; -compile-custom&nbsp; -compile-command=./check.sh&nbsp; -opt-command=./bin/opt slp.ll&nbsp;</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Read input file&nbsp; &nbsp; &nbsp; : 'slp.ll'</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>*** All input ok</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Initializing execution environment: Found command in: ./check.sh</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Running the code generator to test for a crash:&nbsp;</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Error running tool:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp; ./check.sh bugpoint-test-program-1aa0e1d.bc</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>*** Debugging code generator crash!</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Checking to see if we can delete global inits: &lt;crash></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>*** Able to remove all global initializers!</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Checking for crash with only these blocks:&nbsp; &nbsp; .lr.ph6.preheader .preheader .lr.ph.preheader .lr.ph .backedge&nbsp; ._crit_edge.loopexit... &lt;11 total>: &lt;crash></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Checking for crash with only these blocks: .preheader .backedge .lr.ph6.preheader:&nbsp;</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Checking for crash with only these blocks: .lr.ph ._crit_edge:&nbsp;</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>...</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>...</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Checking instruction: &nbsp; store i8 %16, i8* getelementptr inbounds ([32 x i8], [32 x i8]* @cle, i64 0, i64 15), align 1, !tbaa !2</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>*** Attempting to perform final cleanups: &lt;crash></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>Emitted bitcode to 'bugpoint-reduced-simplified.bc'</div><div><br></div>In practice the ability to write a custom script is very powerful, I will go over a few use cases I recently used&nbsp;<i>bugpoint</i>&nbsp;with.<br><h2 style=text-align:left>Search For a String in the Output</h2>I recently submitted a patch (http://reviews.llvm.org/D14364) for a case where the loop vectorizer didn't kick-in on a quite simple test case. After fixing the underlying issue I needed to submit a test with my patch. The original IR was a few hundred lines. Since I believe it is good practice to reduce test cases as much as possible, bugpoint is often my best friend. In this case the analysis result indicates "Memory dependences are safe with run-time checks" on the output after my patch.<br><br>Having compiled `opt` with and without my patch and copied each version in `/tmp/` I wrote this shell script:<br><br><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal><br></div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>#!/bin/bash</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#c33720;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>/tmp/opt.original&nbsp;</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-loop-accesses</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-analyze</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$1</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;|&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>grep</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>"</span>Memory dependences are safe<span style=color:#ce7924>"</span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal>res_original<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>=</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$?</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>/tmp/opt.patched&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-loop-accesses</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-analyze</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$1</span>&nbsp;|&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>grep</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>"</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>Memory dependences are safe</span><span style=color:#ce7924>"</span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal>res_patched<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>=</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$?</span></div><div style=background-color:#000;color:#d53bd3;font-family:Monaco;font-size:12px;line-height:normal>[[<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>$res_original<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>==</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>1</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>&&</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>$res_patched<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>==</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>]]<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&&&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>exit</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>1</span></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>exit<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span></div><br>It first runs the bitcode supplied as argument to the script (the $1 above) through&nbsp;<i>opt</i>&nbsp;and uses&nbsp;<i>grep</i>&nbsp;to check for the presence of the expected string in the output. When&nbsp;<i>grep</i>&nbsp;exits,&nbsp;<i>$?</i>&nbsp;contains with 1 if the string is&nbsp;<b>not</b>&nbsp;present in the output. The reduced test case is valid if the original&nbsp;<i>opt</i>&nbsp;didn't produce the expected analysis but the new&nbsp;<i>opt</i>&nbsp;did.<br><h2>Reduce While a Transformation Makes Effects</h2>In another case (http://reviews.llvm.org/D13996), I patched the SLP vectorizer and I wanted to reduce the test case so that it didn't vectorize before my changes but vectorizes after:<br><br><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>#!/bin/bash</div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>set<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-e</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>/tmp/opt.original&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-slp-vectorizer</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-S</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>></span>&nbsp;/tmp/original.ll&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$1</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>/tmp/opt.patched&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-slp-vectorizer</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-S</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>></span>&nbsp;/tmp/patched.ll&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$1</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>diff /tmp/original.ll /tmp/patched.ll &&&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>exit</span>&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#ce7924>exit</span>&nbsp;<span style=color:#c33720>1</span></div><br>The use of a custom script offers flexibility and allows to run any complex logic to decide if a reduction is valid or not. I used it in the past to reduce crashes on a specific assertion and avoiding the reduction leading to a different crash, or to reduce for tracking instruction count regressions or any other metric.<br><h2>Just Use FileCheck</h2><div>LLVM comes with a&nbsp;<a href=http://llvm.org/docs/CommandGuide/FileCheck.html>Flexible pattern matching file verifier</a>&nbsp;(FileCheck) that the tests are using intensively. You can annotate your original test case and write a script that reduce it for your patch. Let's take an example from the public LLVM repository with commit&nbsp;r252051<i>&nbsp;"</i>[SimplifyCFG] Merge conditional stores<i>".</i>&nbsp;The associated test in the validation is test/Transforms/SimplifyCFG/merge-cond-stores.ll ; and it already contains all the check we need, let's try to reduce it. For this purpose you'll need to process one function at a time, or bugpoint may not produce what you expect: because the check will fail for one function, bugpoint can do any transformation to another function and the test would still be considered "interesting". Let's extract the function test_diamond_simple from the original file:</div><div><br></div><div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>$ ./bin/llvm-extract -func=test_diamond_simple test/Transforms/SimplifyCFG/merge-cond-stores.ll -S > /tmp/my_test_case.ll</div></div><div><br></div><div>Then checkout and compile&nbsp;<i>opt</i>&nbsp;for revision r252050 and r252051, and copy them in /tmp/opt.r252050&nbsp;and /tmp/opt.r252051. The check.sh script is then based on the&nbsp;<i>CHECK</i>&nbsp;line in the original test case:</div><div><br></div><div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>#!/bin/bash</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal># Process the test before the patch and check with FileCheck,<br># this is expected to fail.</div><div style=background-color:#000;line-height:normal><span style=color:#f5f5f5;font-family:monaco><span style=font-size:12px>/tmp/opt.r252050&nbsp;</span></span><span style=color:#d53bd3;font-family:monaco;font-size:12px>-simplifycfg</span>&nbsp;<span style=color:#d53bd3;font-family:monaco;font-size:12px>-instcombine</span>&nbsp;<span style=color:#d53bd3;font-family:monaco;font-size:12px>-phi-node-folding-threshold</span><span style=color:#ce7924;font-family:monaco;font-size:12px>=</span><span style=color:#c33720;font-family:monaco;font-size:12px>2</span>&nbsp;<span style=color:#d53bd3;font-family:monaco;font-size:12px>-S</span>&nbsp;<span style=color:#ce7924;font-family:monaco;font-size:12px>&lt;</span>&nbsp;<span style=color:#d53bd3;font-family:monaco><span style=font-size:12px>$1 | ./bin/FileCheck&nbsp;merge-cons-stores.ll</span></span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal>original<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>=</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$?</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal># Process the test after the patch and check with FileCheck,<br># this is expected to succeed.</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>/tmp/opt.r252051&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-simplifycfg</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-instcombine</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-phi-node-folding-threshold</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>=</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>2</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>-S</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>&lt;</span>&nbsp;<span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$1 |&nbsp;</span><span style=color:#d53bd3>./bin/FileCheck&nbsp;merge-cons-stores.ll</span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal>patched<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>=</span><span style=color:#d53bd3;font-variant-ligatures:no-common-ligatures>$?</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal># The test is interesting if FileCheck failed before and<br># succeed after the patch.</div><div style=background-color:#000;color:#d53bd3;font-family:Monaco;font-size:12px;line-height:normal>[[<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>$original<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>!=</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>&&</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>$patched<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>==</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>]]<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&&&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>exit</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>1</span></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>exit<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div></div><div><br></div><div>I intentionally selected a very well written test to show you both the power of bugpoint and its limitation. If you look at the function we just extracted in&nbsp;<i>my_test_case.ll</i>&nbsp;for instance:</div><div><br></div><div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>; CHECK-LABEL: @test_diamond_simple</div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>; This should get if-converted.</div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>; CHECK: store</div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>; CHECK-NOT: store</div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>; CHECK: ret</div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>define</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>@test_diamond_simple<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>(</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>*&nbsp;</span>%p<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>*&nbsp;</span>%q<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%a<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%b<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>) {</span></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>entry:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x1</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>icmp</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>eq</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%a</span>,&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>i1<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x1</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%no1</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%yes1</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>yes1:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>store</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>*&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%p</span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>label</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%fallthrough</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>no1:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z1</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>add</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%a</span>,&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>label</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%fallthrough</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>fallthrough:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z2</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>phi</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;[&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z1</span>,&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%no1</span>&nbsp;], [&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span>,&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%yes1</span>&nbsp;]</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x2</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>icmp</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>eq</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span>,&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>i1<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x2</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%no2</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%yes2</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>yes2:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>store</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>1</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>*&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%p</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%end</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>no2:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z3</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>sub</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z2</span>,&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%end</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures><br></span></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>end:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px>&nbsp;&nbsp;<span style=color:#34bbc7>%z4</span>&nbsp;=&nbsp;<span style=color:#ce7924>phi</span>&nbsp;<span style=color:#34bd26>i32</span>&nbsp;[&nbsp;<span style=color:#34bbc7>%z3</span>,&nbsp;<span style=color:#34bbc7>%no2</span>&nbsp;], [&nbsp;<span style=color:#c33720>3</span>,&nbsp;<span style=color:#34bbc7>%yes2</span>&nbsp;]</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>ret</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z4</span></div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>}</div></div><div><br></div><div>The transformation introduced in this patch allows to merge the stores in the true branches&nbsp;<span style=background-color:#000;color:#ce7924;font-family:monaco;font-size:12px>yes1</span>&nbsp;and&nbsp;<span style=background-color:#000;color:#ce7924;font-family:monaco;font-size:12px>yes2</span>:</div><div><br></div><div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>declare<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>void</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>@f</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>()</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>define</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>@test_diamond_simple<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>(</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>*&nbsp;</span>%p<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>*&nbsp;</span>%q<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%a<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%b<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>) {</span></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>entry:</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x1</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>icmp</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>eq</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%a</span>,&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z1</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>add</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%a</span>,&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z2</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>select</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i1</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x1</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z1</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x2</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>icmp</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>eq</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span>,&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z3</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>sub</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z2</span>,&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z4</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>select</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i1</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x2</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z3</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>3</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%0</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>or</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%a</span>,&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%1</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>icmp</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>eq</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%0</span>,&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>i1<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%1</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%3</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%2</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>; &lt;label>:2 ; preds = %entry</div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span>%simplifycfg.merge<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;=&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>select</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i1</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%x2<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%z2<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>1</span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>store</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%simplifycfg.merge<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>*&nbsp;</span>%p<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>align</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>4</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%3</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#5330e1;font-family:Monaco;font-size:12px;line-height:normal>; &lt;label>:3 ; preds = %entry, %2</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>ret</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%z4</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>}</div></div><div><br></div><div>The original code seems pretty minimal, the variable and block names are explicit, it is easy to follow and you probably wouldn't think about reducing it. For the exercise, let's have a look at what bugpoint can do for us here:</div><div><br></div><div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>define</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>void</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>@test_diamond_simple<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>(</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>*&nbsp;</span>%p<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%b<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>) {</span></div><div style=background-color:#000;color:#ce7924;font-family:Monaco;font-size:12px;line-height:normal>entry:</div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i1</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#c33720;font-variant-ligatures:no-common-ligatures>undef</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>label</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%fallthrough<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>label</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%yes1</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>yes1:</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style=color:#5330e1;font-variant-ligatures:no-common-ligatures>; preds = %entry</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>store</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>*&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%p</span></div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>label</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>%fallthrough</div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>fallthrough:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style=color:#5330e1;font-variant-ligatures:no-common-ligatures>; preds = %yes1, %entry</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x2</span>&nbsp;=&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>icmp</span>&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>eq</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%b</span>,&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>0</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>i1<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%x2</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%end</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>,&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%yes2</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><br></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>yes2:</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style=color:#5330e1;font-variant-ligatures:no-common-ligatures>; preds = %fallthrough</span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>&nbsp;&nbsp;<span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>store</span>&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>&nbsp;<span style=color:#c33720;font-variant-ligatures:no-common-ligatures>1</span>,&nbsp;<span style=color:#34bd26;font-variant-ligatures:no-common-ligatures>i32</span>*&nbsp;<span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%p</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>br</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>label<span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures>%end</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#34bbc7;font-variant-ligatures:no-common-ligatures><br></span></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal;min-height:16px><span style=color:#ce7924>yes2:</span>&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style=color:#5330e1>; preds = %yes2, %fallthrough</span></div><div style=background-color:#000;color:#34bd26;font-family:Monaco;font-size:12px;line-height:normal><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;&nbsp;</span><span style=color:#ce7924;font-variant-ligatures:no-common-ligatures>ret</span><span style=color:#f5f5f5;font-variant-ligatures:no-common-ligatures>&nbsp;</span>void</div><div style=background-color:#000;color:#34bbc7;font-family:Monaco;font-size:12px;line-height:normal></div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>}</div></div><div><br></div><div>Bugpoint figured out that the&nbsp;<i>no</i>&nbsp;branches were useless for this test and removed them. The drawback is that bugpoint also has a tendency to introduce&nbsp;<i>undef</i>&nbsp;or&nbsp;<i>unreachable&nbsp;</i>here and there, which can make the test more fragile and harder to understand.&nbsp;&nbsp;</div><h2 style=text-align:left>Not There Yet: Manual Cleanup</h2><div>At the end of the reduction, the test is small but probably not ready to be submitted with your patch "as is". Some cleanup is probably still needed: for instance bugpoint won't convert invoke into calls, &nbsp;remove metadata, tbaa informations, personality function, etc. We also saw before that bugpoint can modify your test in unexpected way, adding&nbsp;<i>undef</i>&nbsp;or&nbsp;<i>unreachable</i>.&nbsp;Also you probably want to rename the variables to end up with a readable test case.</div><div><br></div><div>Fortunately, having the&nbsp;<i>check.sh</i>&nbsp;script at hand is helpful in this process, since you can just manually modify your test and run continuously the same command:</div><div><br></div><div><div style=background-color:#000;color:#f5f5f5;font-family:Monaco;font-size:12px;line-height:normal>$ ./check.sh my_test_case.ll && echo "NON-INTERESTING" || echo "INTERESTING"</div></div><div><br></div><div>While the result is &nbsp;<span style=background-color:#000;color:#f5f5f5;font-family:monaco;font-size:12px>INTERESTING</span>&nbsp;you know you keep having a valid test and you can continue to proceed with your cleanup.</div><div><br></div><div>Keep in mind that bugpoint can do far more, but hopefully this subset will be helpful to the ones that are still struggling with its command line options.<br><br>Finally, I'm grateful to Manman Ren for her review of this post.</div></div></article><section class=post-nav><ul><li><a href=https://blog.llvm.org/2015/11/llvm-weekly-97-nov-9th-2015.html><i class="fa fa-chevron-circle-left"></i> LLVM Weekly - #97, Nov 9th 2015</a></li><li><a href=https://blog.llvm.org/2015/11/llvm-weekly-98-nov-16th-2015.html>LLVM Weekly - #98, Nov 16th 2015 <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><ul><li><h6>llvm.org |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://blog.llvm.org/index.xml>Subscribe</a></h6></li></ul></footer></div><script src=https://blog.llvm.org/js/scripts.js></script></body></html>
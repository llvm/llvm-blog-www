<!doctype html><html lang=en>
<head>
<title>GSoC 2024: Half-precision in LLVM libc - The LLVM Project Blog</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="LLVM Project News and Details from the Trenches">
<meta name=author content="Nicolas Celik"><meta property="og:title" content="GSoC 2024: Half-precision in LLVM libc">
<meta property="og:description" content="C23 defines new floating-point types, such as _Float16, which corresponds to the binary16 format from IEEE Std 754, also known as &ldquo;half-precision,&rdquo; or FP16. C23 also defines new variants of the C standard library&rsquo;s math functions accordingly, such as fabsf16 to get the absolute value of a _Float16.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.llvm.org/posts/2024-08-31-half-precision-in-llvm-libc/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2024-08-31T00:00:00+00:00">
<meta property="article:modified_time" content="2024-08-31T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="GSoC 2024: Half-precision in LLVM libc">
<meta name=twitter:description content="C23 defines new floating-point types, such as _Float16, which corresponds to the binary16 format from IEEE Std 754, also known as &ldquo;half-precision,&rdquo; or FP16. C23 also defines new variants of the C standard library&rsquo;s math functions accordingly, such as fabsf16 to get the absolute value of a _Float16.">
<meta name=generator content="Hugo 0.89.4">
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous>
<link rel=stylesheet href=https://blog.llvm.org/fontawesome/css/all.min.css>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda">
<link rel=stylesheet type=text/css href=https://blog.llvm.org/css/styles.css></head>
<body>
<div id=container>
<header>
<h1>
<a href=https://blog.llvm.org/>The LLVM Project Blog</a>
</h1>
<ul id=social-media>
<li>
<a href=https://www.facebook.com/llvmorg title=Facebook>
<i class="fab fa-facebook fa-lg"></i>
</a>
</li>
<li>
<a href=https://github.com/llvm title=GitHub>
<i class="fab fa-github fa-lg"></i>
</a>
</li>
<li>
<a href=https://twitter.com/llvmorg title=Twitter>
<i class="fab fa-twitter fa-lg"></i>
</a>
</li>
<li>
<a href=https://www.youtube.com/c/LLVMPROJ title=Youtube>
<i class="fab fa-youtube fa-lg"></i>
</a>
</li>
</ul>
<p><em>LLVM Project News and Details from the Trenches</em></p>
</header>
<nav>
<ul>
<li>
<a href=https://blog.llvm.org/about>
<i class="fa-li fa fa-lg"></i><span>About</span>
</a>
</li>
<li>
<a href=https://blog.llvm.org/posts>
<i class="fa-li fa fa-lg"></i><span>Posts</span>
</a>
</li>
<li>
<a href=https://blog.llvm.org/tags>
<i class="fa-li fa fa-lg"></i><span>Tags</span>
</a>
</li>
<li>
<a href=https://llvm.org/>
<i class="fa-li fa fa-lg"></i><span>llvm.org</span>
</a>
</li>
</ul>
</nav>
<main>
<article>
<h1>GSoC 2024: Half-precision in LLVM libc</h1>
<aside>
<ul>
<li>By Nicolas Celik</li>
<li>
<time class=post-date datetime=2024-08-31T00:00:00Z>Aug 31, 2024</time>
</li>
<li>
<em>
<a href=https://blog.llvm.org/tags/gsoc>#GSoC</a>
,
<a href=https://blog.llvm.org/tags/libc>#libc</a>
</em>
</li>
<li>3 minute read</li>
</ul>
</aside>
<p>C23 defines new floating-point types, such as <code>_Float16</code>, which corresponds to
the binary16 format from IEEE Std 754, also known as &ldquo;half-precision,&rdquo; or FP16.
C23 also defines new variants of the C standard library&rsquo;s math functions
accordingly, such as <code>fabsf16</code> to get the absolute value of a <code>_Float16</code>.</p>
<p>The &ldquo;Half-precision in LLVM libc&rdquo; Google Summer of Code 2024 project aimed to
implement these new <code>_Float16</code> math functions in LLVM libc, making it the first
known C standard library implementation to implement these C23 functions.</p>
<p>We split math functions into two categories: basic operations and higher math
functions. The current implementation status of math functions in LLVM libc can
be viewed at <a href=https://libc.llvm.org/math/index.html#implementation-status>https://libc.llvm.org/math/index.html#implementation-status</a>.</p>
<p>The exact goals of this project were to:</p>
<ol>
<li>Setup generated headers properly so that the <code>_Float16</code> type and <code>_Float16</code>
functions can be used with various compilers and architectures.</li>
<li>Add generic implementations of <code>_Float16</code> basic operations for supported
architectures.</li>
<li>Add optimized implementations of <code>_Float16</code> basic operations for specific
architectures using special hardware instructions and compiler builtins
whenever possible.</li>
<li>Add generic implementations of as many <code>_Float16</code> higher math functions as
possible. We knew we would not have enough time to implement all of them.</li>
</ol>
<h2 id=work-done>Work done</h2>
<ol>
<li>The <code>_Float16</code> type can now be used in generated headers, and declarations of
<code>_Float16</code> math functions are generated with <code>#ifdef</code> guards to enable them
when they are supported.
<ul>
<li><a href=https://github.com/llvm/llvm-project/pull/93567>https://github.com/llvm/llvm-project/pull/93567</a></li>
</ul>
</li>
<li>All 70 planned <code>_Float16</code> basic operations have been merged.
<ul>
<li><a href=https://github.com/llvm/llvm-project/issues/93566>https://github.com/llvm/llvm-project/issues/93566</a></li>
</ul>
</li>
<li>The <code>_Float16</code>, <code>float</code> and <code>double</code> variants of various basic operations
have been optimized on certain architectures.
<ul>
<li><a href=https://github.com/llvm/llvm-project/pull/98376>https://github.com/llvm/llvm-project/pull/98376</a></li>
<li><a href=https://github.com/llvm/llvm-project/pull/99037>https://github.com/llvm/llvm-project/pull/99037</a></li>
<li><a href=https://github.com/llvm/llvm-project/pull/100002>https://github.com/llvm/llvm-project/pull/100002</a></li>
</ul>
</li>
<li>Out of the 54 planned <code>_Float16</code> higher math functions, 8 have been merged
and 9 have an open pull request.
<ul>
<li><a href=https://github.com/llvm/llvm-project/issues/95250>https://github.com/llvm/llvm-project/issues/95250</a></li>
</ul>
</li>
</ol>
<p>We ran into unexpected issues, such as:</p>
<ul>
<li>Bugs in Clang 11, which is currently still supported by LLVM libc and used in
post-commit CI.</li>
<li>Some post-commit CI workers having old versions of compiler runtimes that are
missing some floating-point conversion functions on certain architectures.</li>
<li>Inconsistent behavior of floating-point conversion functions across compiler
runtime vendors (GCC&rsquo;s libgcc and LLVM&rsquo;s compiler-rt) and CPU architectures.</li>
</ul>
<p>Due to these issues, LLVM libc currently only enables all <code>_Float16</code> functions
on x86-64 Linux. Some were disabled on AArch64 due to Clang 11 bugs, and all
were disabled on 32-bit Arm and on RISC-V due to issues with compiler runtimes.
Some are not available on GPUs because they take <code>_Float128</code> arguments, and the
<code>_Float128</code> type is not available on GPUs.</p>
<p>There is work in progress to work around issues with compiler runtimes by using
our own floating-point conversion functions.</p>
<h2 id=work-left-to-do>Work left to do</h2>
<ul>
<li>Implement the remaining <code>_Float16</code> higher math functions.</li>
<li>Enable the <code>_Float16</code> math functions that are disabled on AArch64 once LLVM
libc bumps its minimum supported Clang version.</li>
<li>Enable <code>_Float16</code> math functions on 32-bit Arm and on RISC-V once issues with
compiler runtimes are resolved.</li>
</ul>
<h2 id=acknowledgements>Acknowledgements</h2>
<p>I would like to thank my Google Summer of Code mentors, Tue Ly and Joseph Huber,
as well as other LLVM maintainers I interacted with, for their help. I would
also like to thank Google for organizing this program.</p>
</article>
<section class=post-nav>
<ul>
<li>
<a href=https://blog.llvm.org/posts/2024-08-09-libc-gpu-benchmarking/><i class="fa fa-chevron-circle-left"></i> GSoC 2024: GPU Libc Benchmarking</a>
</li>
<li>
</li>
</ul>
</section>
</main>
<footer>
<ul>
<li>
<h6>llvm.org |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://blog.llvm.org/index.xml>Subscribe </a></h6>
</li>
</ul>
</footer>
</div>
<script src=https://blog.llvm.org/js/scripts.js></script>
</body>
</html>
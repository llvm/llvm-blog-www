<!doctype html><html lang=en><head><title>The LLVM Project Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="LLVM Project News and Details from the Trenches"><meta name=author content="Marshall Clow"><meta property="og:title" content="Testing libc++ with Address Sanitizer"><meta property="og:description" content="[This article is re-posted in a slightly expanded form from Marshall's blog]
I've been running the libc++ tests off and on for a while. It's a quite extensive test suite, but I wondered if there were any bugs that the test suite was not uncovering."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.llvm.org/posts/2013-03-28-testing-libc-with-address-sanitizer/"><meta property="article:published_time" content="2013-03-28T14:02:00+00:00"><meta property="article:modified_time" content="2013-03-28T14:02:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Testing libc++ with Address Sanitizer"><meta name=twitter:description content="[This article is re-posted in a slightly expanded form from Marshall's blog]
I've been running the libc++ tests off and on for a while. It's a quite extensive test suite, but I wondered if there were any bugs that the test suite was not uncovering."><meta name=generator content="Hugo 0.68.3"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://blog.llvm.org/fontawesome/css/all.min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda"><link rel=stylesheet type=text/css href=https://blog.llvm.org/css/styles.css></head><body><div id=container><header><h1><a href=https://blog.llvm.org/>The LLVM Project Blog</a></h1><ul id=social-media><li><a href=https://www.facebook.com/llvmorg title=Facebook><i class="fab fa-facebook fa-lg"></i></a></li><li><a href=https://github.com/llvm title=GitHub><i class="fab fa-github fa-lg"></i></a></li><li><a href=https://twitter.com/llvmorg title=Twitter><i class="fab fa-twitter fa-lg"></i></a></li><li><a href=https://www.youtube.com/c/LLVMPROJ title=Youtube><i class="fab fa-youtube fa-lg"></i></a></li></ul><p><em>LLVM Project News and Details from the Trenches</em></p></header><nav><ul><li><a href=https://blog.llvm.org/about><i class="fa-li fa fa-lg"></i><span>About</span></a></li><li><a href=https://blog.llvm.org/posts><i class="fa-li fa fa-lg"></i><span>Posts</span></a></li><li><a href=https://blog.llvm.org/tags><i class="fa-li fa fa-lg"></i><span>Tags</span></a></li><li><a href=https://llvm.org/><i class="fa-li fa fa-lg"></i><span>llvm.org</span></a></li></ul></nav><main><article><h1>Testing libc++ with Address Sanitizer</h1><aside><ul><li><time class=post-date datetime=2013-03-28T14:02:00Z>Mar 28, 2013</time></li><li>Marshall Clow</li><li><em><a href=https://blog.llvm.org/tags/sanitizer>#sanitizer</a>
,
<a href=https://blog.llvm.org/tags/c++>#C++</a>
,
<a href=https://blog.llvm.org/tags/clang>#Clang</a></em></li><li>3 minutes read</li></ul></aside><i>[This article is re-posted in a slightly expanded form <a href=http://cplusplusmusings.wordpress.com/2013/03/20/testing-libc-with-address-sanitizer/>from Marshall's blog</a>]</i><br>I've been running the libc++ tests off and on for a while. It's a quite extensive test suite, but I wondered if there were any bugs that the test suite was not uncovering. In the upcoming clang 3.3, there is a new feature named <a href=http://clang.llvm.org/docs/AddressSanitizer.html>Address Sanitizer</a> which inserts a bunch of runtime checks into your executable to see if there are any "out of bounds" reads and writes to memory.<br>In the back of my head, I've always thought that it would be nice to be able to say that libc++ was "ASan clean" (i.e, passed all of the test suite when running with Address Sanitizer).<br>So I decided to do that.<br><br><a name=more></a>[ All of this work was done on Mac OS X 10.8.2/3 ]<h3>How to run the tests:</h3>There's a script for running the tests. It's called <code>testit</code>.<br><pre><code>    $ cd $LLVM/libcxx/test ; ./testit<br></code></pre><pre><code><br></code></pre>where $LLVM/libcxx is where libc++ is checked out. This takes about 30 minutes to run. Without Address Sanitizer, libc++ fails 12 out of the 4348 tests on my system.<h3>Running the tests with Address Sanitizer</h3><pre><code>    $ cd $LLVM/libcxx/test ; CC=/path/to/tot/clang++ OPTIONS= "-std=c++11 -stdlib=libc++ -fsanitize=address" ./testit<br></code></pre><em>Note: the default options are "-std=c++11 -stdlib=libc++", that's what you get if you don't specify anything</em>.This takes about 92 minutes; just a bit more than three times as long. With Address Sanitizer, libc++ fails 54 tests (again, out of 4348)<br><br>What are the failures?<br><br><ul><li>In 11 tests, Address Sanitizer detected a one-byte write outside a heap block. All of these involve iostreams. I created a small test program that ASan also fires on, and sent it to Howard Hinnant (who wrote most of libc++), and he found a place where he was allocating a zero-byte buffer by mistake. One bug, multiple failures. He fixed this in revision <a href="http://llvm.org/viewvc/llvm-project?rev=177452&view=rev">177452</a>.</li><li>2 tests for std::random were failing. This turned out to be an off-by-one error in the test code, not in libc++. I fixed these in revisions <a href="http://llvm.org/viewvc/llvm-project?rev=177355&view=rev">177355</a> and <a href="http://llvm.org/viewvc/llvm-project?rev=177464&view=rev">177464</a>.</li><li>Address Sanitizer detected memory allocations failing in 4 cases. This is expected, since some of the tests are testing the memory allocation system of libc++. However, it appears that ASan does not call the user-supplied <code>new_handler</code> when memory allocation fails (and may not throw <code>std::bad_alloc</code>, ether). I have filed <a href="http://llvm.org/bugs/show_bug.cgi?id=15544">PR15544</a> to track this issue.</li><li>25 cases are failing where the program is failing to load, due to a missing symbol. This is most commonly <code>std::__1::__get_sp_mut(void const *)</code>, but there are a couple others. Howard says that this was added to libc++ after 10.8 shipped, so it's not in the dylib in /usr/lib. If the tests are run with a copy of libc++ built from source, they pass.</li><li>There are the 12 cases that were failing before enabling Address Sanitizer.</li></ul>Once Howard and I fixed the random tests and the bug in the iostreams code, I re-ran the tests using a recently build libc++.dylib.<br><pre><code>    $ cd $LLVM/libcxx/test ; DYLD_LIBRARY_PATH=$LLVM/libcxx/lib CC=/path/to/tot/clang++ OPTIONS= "-std=c++11 -stdlib=libc++ -fsanitize=address" ./testit<br></code></pre>This gave us 16 failures:<br><ul><li>The 4 failures that have to do with memory allocation failures.</li><li>The 12 failures that we started with.</li></ul><br><h4>Conclusion</h4>I'm glad to see that there were so few problems in the libc++ code. It's a fundamental building block for applications on Mac OS X (and, as llvm becomes more popular, other systems). And now it's better than it was when we started this exercise.However, we did find a couple bugs in the test suite, and one heap-smashing bug in libc++. We also found a limitation in Address Sanitizer, too - which the developers are working on addressing.<br><br><br><br><br><br><br><br><br><br><br></article><section class=post-nav><ul><li><a href=https://blog.llvm.org/posts/2013-03-20-instruction-relationship-framework-in/><i class="fa fa-chevron-circle-left"></i>Instruction Relationship Framework in LLVM</a></li><li><a href=https://blog.llvm.org/posts/2013-04-01-testing-libc-with-fsanitizeundefined/>Testing libc++ with -fsanitize=undefined <i class="fa fa-chevron-circle-right"></i></a></li></ul></section></main><footer><h6>llvm.org |
Rendered by <a href=https://gohugo.io title=Hugo>Hugo</a> |
<a href=https://blog.llvm.org/index.xml>Subscribe</a></h6></footer></div><script src=https://blog.llvm.org/js/scripts.js></script></body></html>